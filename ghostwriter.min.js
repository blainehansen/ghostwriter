// ghostwriter
// ===========
// * GitHub: https://github.com/jharding/ghostwriter
// * Copyright (c) 2013 Jake Harding
// * Licensed under the MIT license.
(function(t,e){e.ghostwriter=t;var r=function(){var t=Array.prototype.forEach,e=Array.prototype.map,n=Function.prototype.bind,i=Array.prototype.slice,o={},a=function(){};return{isString:function(t){return"string"==typeof t},isArray:function(t){"[object Array]"===Object.prototype.toString.call(t)},each:function(e,r,n){if(e)if(t&&e.forEach===t)e.forEach(r,n);else if(e.length===+e.length){for(var i=0,a=e.length;a>i;i++)if(r.call(n,e[i],i,e)===o)return}else for(var s in e)if(e.hasOwnProperty(s)&&r.call(n,e[s],s,e)===o)return},map:function(t,n,i){var o=[];return t?e&&t.map===e?t.map(n,i):(r.each(t,function(t,e,r){o[o.length]=n.call(i,t,e,r)}),o):o},bind:function(t,e){var r,o,s,u;if(t.bind===n&&n)return n.apply(t,i.call(arguments,1));if(!_.isFunction(t))throw new TypeError;return o=i.call(arguments,2),s=function(){return!this instanceof s?t.apply(e,o.concat(i.call(arguments))):(ctor.prototype=t.prototype,r=new a,ctor.prototype=null,u=t.apply(self,o.concat(i.call(arguments))),Object(u)===u?u:r)}},merge:function(t){return[].concat.apply([],t)},mixin:function(t){for(var e,r=[].slice.call(arguments,1);e=r.shift();)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},isRepeatified:function(t){return"_repeatified_"in t},repeatify:function(t){var e={};return r.each(t,function(t,r){e[r]=function(e){for(var r=[];e--;)r.push(t);return r},e[r]._repeatified_=!0}),e},getKeyEvent:function(t,e){var n=$.Event(t);return n.which=n.keyCode=r.isString(e)?e.charCodeAt(0):e,n},getCursorPos:function(t){var e=t[0].selectionStart;if(e)return e;if(document.selection){t.focus();var r=document.selection.createRange();return r.moveStart("character",-valueLength),r.text.length}},setCursorPos:function(t,e){var r,n=t[0];n.createTextRange?(r=n.createTextRange(),r.collapse(!0),r.moveEnd(e),r.moveStart(e),r.select()):n.setSelectionRange&&n.setSelectionRange(e,e)}}}(),n={character:function(t,e,n,i){e.trigger(r.getKeyEvent("keydown",t)).trigger(r.getKeyEvent("keypress",t)).trigger(r.getKeyEvent("textInput",t)).trigger(r.getKeyEvent("keyup",t)).val(i.before+t+i.after).trigger(r.getKeyEvent("input",t)),r.setCursorPos(e,n+1)},backspace:function(t,e,n){var i=8,o=0===e?0:e-1;t.trigger(r.getKeyEvent("keydown",i)).val(n.before.substr(0,o)+n.after).trigger(r.getKeyEvent("keyup",i)),t.val()!==n.all&&t.trigger(r.getKeyEvent("input",i)),r.setCursorPos(t,e)},right:function(t,e){var n=39;t.trigger(r.getKeyEvent("keydown",n)),r.setCursorPos(t,e+1),t.trigger(r.getKeyEvent("keyup",n))},left:function(t,e){var n=37;t.trigger(r.getKeyEvent("keydown",n)),r.setCursorPos(t,e-1),t.trigger(r.getKeyEvent("keyup",n))},up:function(t){var e=38;t.trigger(r.getKeyEvent("keydown",e)),t.trigger(r.getKeyEvent("keyup",e))},down:function(t){var e=40;t.trigger(r.getKeyEvent("keydown",e)),t.trigger(r.getKeyEvent("keyup",e))},enter:function(t){var e=13;t.trigger(r.getKeyEvent("keydown",e)),t.trigger(r.getKeyEvent("keyup",e))},tab:function(t){var e=9;t.trigger(r.getKeyEvent("keydown",e)),t.trigger(r.getKeyEvent("keyup",e))},esc:function(t){var e=27;t.trigger(r.getKeyEvent("keydown",e)),t.trigger(r.getKeyEvent("keyup",e))},selectAll:function(t){t.select()},deleteAll:function(t,e,n){var i=8;t.trigger(r.getKeyEvent("keydown",i)).val("").trigger(r.getKeyEvent("keyup",i)),t.val()!==n.all&&t.trigger(r.getKeyEvent("input",i))},noop:function(){}},i=function(){function t(t){this.loop=!!t.loop,this.intervalId=null,this.interval=t.interval||300,this.$input=$(t.input),this.originalInputVal=this.$input.val(),this.story=[],this.manuscript=e(t.manuscript)}function e(t){return t=r.isString(t)?[t]:t,t=r.map(t,function(t){return r.isString(t)?r.map(t.split(""),function(t){return r.bind(n.character,null,t)}):r.isRepeatified(t)?t(1):t}),r.merge(t)}function i(){var t=this.story.shift(),e=r.getCursorPos(this.$input)||0,n=this.$input.val(),i=n.substr(0,e),o=n.substr(e);switch(typeof t){case"function":t(this.$input,e,{all:n,before:i,after:o});break;case"undefined":this.loop?this.restart():this.stop();break;default:throw Error("bad story")}}return r.mixin(t.prototype,{start:function(){return this.intervalId||(this.$input.focus(),this.story=this.story.length?this.story:this.manuscript.slice(0),this.intervalId=setInterval(r.bind(i,this),this.interval)),this},pause:function(){return this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this},stop:function(){return this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,this.$input.blur(),this.$input.val(this.originalInputVal)),this},restart:function(){return this.stop(),this.$input.val(this.originalInputVal),this.story=[],this.start(),this}}),t}();r.mixin(t,r.repeatify(n),{haunt:function(t){return new i(t)}}),delete t.character})({},function(){return this}());